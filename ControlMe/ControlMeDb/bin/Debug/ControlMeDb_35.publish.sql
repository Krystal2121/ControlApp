/*
Deployment script for ControlMe

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "ControlMe"
:setvar DefaultFilePrefix "ControlMe"
:setvar DefaultDataPath "D:\Program Files\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\"
:setvar DefaultLogPath "D:\Program Files\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Rename refactoring operation with key 63ef9d76-38aa-4c13-bdae-9291bea960d6 is skipped, element [dbo].[Users].[Login] (SqlSimpleColumn) will not be renamed to LoginDate';


GO
PRINT N'Altering Table [dbo].[Users]...';


GO
ALTER TABLE [dbo].[Users]
    ADD [LoginDate] DATETIME DEFAULT getdate() NOT NULL,
        [ThumbsUp]  INT      DEFAULT 0 NULL;


GO
PRINT N'Altering Table [dbo].[VarificationReq]...';


GO
ALTER TABLE [dbo].[VarificationReq]
    ADD [Sent] BIT DEFAULT 0 NULL;


GO
PRINT N'Altering Procedure [dbo].[USP_GetOutstanding]...';


GO
ALTER PROCEDURE [dbo].[USP_GetOutstanding]
	@userID int = 0
AS
BEGIN

	DELETE cmd FROM ControlAppCmd cmd
	WHERE SenderId in (Select BlockeeId FROM Block where BlockerId=@userID)
	AND SubId=@userID

	DECLARE @Anon bit = 0
	DECLARE @vari bit=0
	DECLARE @Thumbs int=0
	SELECT @Anon=AnonCmd, @vari=Varified , @Thumbs=ThumbsUp from Users where ID=@userID

	IF (@Anon=0)
	BEGIN
		DELETE cmd FROM ControlAppCmd cmd
		WHERE SenderId =-1
		AND SubId=@userID
	END

	declare @whonext varchar(20)

	select top 1 @whonext= isnull(GroupRefId,SenderId)
	from [ControlAppCmd] c
	join CommandList cl
	on c.CmdId=cl.CmdId
	where SubId=@userID order by [SendDate]

	update Users
	set LoginDate=getdate()
	where ID=@userID

	if Convert(int,@whonext )<-1
	begin
		select @whonext= 'Group: '+ GroupName from Groups where RefId=@whonext
	end
	else
	begin
		if Convert(int,@whonext )=-1
		begin
			set @whonext='Anon'
		end
		else
		begin
			set @whonext=''
			select @whonext=u.[Screen Name] from users u join Relationship r on u.Id=r.DomID
			where r.SubID=@userID
			if(@whonext='')
				set @whonext='User'
		end
	end
	SELECT convert(varchar(100),count(*)) counting,  @whonext whonext, @vari varified, @Thumbs Thumbs  from ControlAppCmd where SubId=@userID
END
GO
PRINT N'Altering Procedure [dbo].[Usp_GetVerificationReq]...';


GO
ALTER PROCEDURE [dbo].[Usp_GetVerificationReq]

AS
	SELECT  u.[Screen Name] [User],u.[Login Name] Email,'<a href="mailto:'+u.[Login Name]+'?subject=Verify &body='+ convert(varchar(4),u.VarifiedCode) +'">Email</a>' Code, vr.Count Tried
	FROM Users u
	JOIN VarificationReq vr
	on u.Id=vr.SubID
	where vr.Sent=0;
GO
PRINT N'Altering Procedure [dbo].[USP_Login]...';


GO
ALTER PROCEDURE [dbo].[USP_Login]
	@UserName varchar(255),
	@Password varchar(255)
AS
BEGIN
	SELECT Id, [Role],Varified from Users where [Screen Name]=@UserName and Password=@Password
END
GO
PRINT N'Creating Procedure [dbo].[usp_bestsender]...';


GO
CREATE PROCEDURE [dbo].[usp_bestsender]

AS
	SELECT top 5
	[Screen Name],
	[ThumbsUp]
	from users
	order by ThumbsUp desc
RETURN 0
GO
PRINT N'Creating Procedure [dbo].[USP_GetAllAppContent]...';


GO
CREATE PROCEDURE [dbo].[USP_GetAllAppContent]
@userID int = 0
AS
BEGIN

DELETE cmd FROM ControlAppCmd cmd
WHERE SenderId in (Select BlockeeId FROM Block where BlockerId=@userID)
AND SubId=@userID

DECLARE @Anon bit = 0
SELECT @Anon=AnonCmd from Users where ID=@userID

IF (@Anon=0)
BEGIN
DELETE cmd FROM ControlAppCmd cmd
WHERE SenderId =-1
AND SubId=@userID
END

SELECT cac.Id CacId, convert(varchar(100),SenderId) SenderId, cl.Content, case when r.Id is null then 'N' else 'D' end IsDom from ControlAppCmd cac
join CommandList cl
on cac.CmdId=cl.CmdId
left join Relationship r
on r.DomID=SenderId
and r.SubID=@userID
where cac.SubId=@userID
ORDER BY SendDate

END
GO
PRINT N'Creating Procedure [dbo].[usp_thumbsup]...';


GO
CREATE PROCEDURE [dbo].[usp_thumbsup]
	@id int ,
	@senderid int
AS
	if(select count(*) from dbo.users where id=@senderid)>0
	BEGIN
		if @id!=@senderid
		BEGIN
		update users set ThumbsUp=ThumbsUp+1 where id=@senderid
		END

	END
RETURN 0
GO
PRINT N'Creating Procedure [dbo].[usp_userinfo]...';


GO
CREATE PROCEDURE [dbo].[usp_userinfo]
	@username varchar(255)='',
	@id int=0
AS
BEGIN
	if @username!=''
	begin
		select * from users where [Screen Name]=@username
	END
	ELSE if @id!=0
	BEGIN
		select * from users where id=@id
	END
END
GO
PRINT N'Creating Procedure [dbo].[usp_veriySent]...';


GO
CREATE PROCEDURE [dbo].[usp_veriySent]
	@Username varchar(250)
AS
	update vr
	set vr.Sent=1
	FROM VarificationReq vr
	JOIN Users u
	on u.Id=vr.SubID
	where u.[Screen Name]=@Username
GO
PRINT N'Refreshing Procedure [dbo].[USP_AcceptInvite]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[USP_AcceptInvite]';


GO
PRINT N'Refreshing Procedure [dbo].[USP_AddInvite]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[USP_AddInvite]';


GO
PRINT N'Refreshing Procedure [dbo].[USP_AdminCommandLog]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[USP_AdminCommandLog]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_checkexisting]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_checkexisting]';


GO
PRINT N'Refreshing Procedure [dbo].[Usp_checkuser]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[Usp_checkuser]';


GO
PRINT N'Refreshing Procedure [dbo].[USP_DeleteInvite]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[USP_DeleteInvite]';


GO
PRINT N'Refreshing Procedure [dbo].[USP_GetAppContent]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[USP_GetAppContent]';


GO
PRINT N'Refreshing Procedure [dbo].[USP_GetChatLog]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[USP_GetChatLog]';


GO
PRINT N'Refreshing Procedure [dbo].[USP_GetDom]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[USP_GetDom]';


GO
PRINT N'Refreshing Procedure [dbo].[USP_GetGroups]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[USP_GetGroups]';


GO
PRINT N'Refreshing Procedure [dbo].[USP_GetInvites]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[USP_GetInvites]';


GO
PRINT N'Refreshing Procedure [dbo].[USP_GetInvites2]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[USP_GetInvites2]';


GO
PRINT N'Refreshing Procedure [dbo].[USP_GetRels]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[USP_GetRels]';


GO
PRINT N'Refreshing Procedure [dbo].[USP_GetSub]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[USP_GetSub]';


GO
PRINT N'Refreshing Procedure [dbo].[USP_GetUserSettings]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[USP_GetUserSettings]';


GO
PRINT N'Refreshing Procedure [dbo].[USP_Register]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[USP_Register]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_requestvar]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_requestvar]';


GO
PRINT N'Refreshing Procedure [dbo].[USP_SendAppCmd]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[USP_SendAppCmd]';


GO
PRINT N'Refreshing Procedure [dbo].[USP_SendChat]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[USP_SendChat]';


GO
PRINT N'Refreshing Procedure [dbo].[USP_UpdateSettings]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[USP_UpdateSettings]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_varify]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_varify]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_tidyup]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_tidyup]';


GO
-- Refactoring step to update target server with deployed transaction logs
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '63ef9d76-38aa-4c13-bdae-9291bea960d6')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('63ef9d76-38aa-4c13-bdae-9291bea960d6')

GO

GO
PRINT N'Update complete.';


GO
