/*
Deployment script for ControlMe

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "ControlMe"
:setvar DefaultFilePrefix "ControlMe"
:setvar DefaultDataPath "D:\Program Files\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\"
:setvar DefaultLogPath "D:\Program Files\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Altering Table [dbo].[VarificationReq]...';


GO
ALTER TABLE [dbo].[VarificationReq]
    ADD [VerifyDate] DATETIME NULL;


GO
PRINT N'Altering Procedure [dbo].[USP_GetChatLog]...';


GO
ALTER PROCEDURE [dbo].[USP_GetChatLog]
	@RequestID int ,
	@OtherID int,
	@OtherUser varchar(255) = ''
AS
BEGIN

	declare @newother int
	if @OtherUser!=''
	BEGIN
		select @newother=ID 
		FROM Users
		where [Screen Name]=  @OtherUser
	END
	ELSE
	BEGIN
		SET @newother=@OtherID
	END

	select * from (
	SELECT 'S' Type,ChatTxt,Date_Add
	FROM ChatLog
	where SenderID=@RequestID
	and ReceiverID=@newother

	union

	SELECT 'R' Type,ChatTxt,Date_Add
	FROM ChatLog
	where ReceiverID=@RequestID
	and SenderID=@newother
	) as sub 
	Order by Date_Add
END
GO
PRINT N'Altering Procedure [dbo].[USP_GetOutstanding]...';


GO
ALTER PROCEDURE [dbo].[USP_GetOutstanding]
	@userID int = 0
AS
BEGIN

	DELETE cmd FROM ControlAppCmd cmd
	WHERE SenderId in (Select BlockeeId FROM Block where BlockerId=@userID)
	AND SubId=@userID

	DECLARE @Anon bit = 0
	DECLARE @vari bit=0
	SELECT @Anon=AnonCmd, @vari=Varified from Users where ID=@userID

	IF (@Anon=0)
	BEGIN
		DELETE cmd FROM ControlAppCmd cmd
		WHERE SenderId =-1
		AND SubId=@userID
	END
	declare @whonext varchar(20)
	select top 1 @whonext= isnull(GroupRefId,SenderId)
	from [ControlAppCmd] c
	join CommandList cl
	on c.CmdId=cl.CmdId
	where SubId=@userID order by [SendDate]

	if Convert(int,@whonext )<-1
	begin
		select @whonext= 'Group: '+ GroupName from Groups where RefId=@whonext
	end
	else
	begin
		if Convert(int,@whonext )=-1
		begin
			set @whonext='Anon'
		end
		else
		begin
			set @whonext=''
			select @whonext=u.[Screen Name] from users u join Relationship r on u.Id=r.DomID
			where r.SubID=@userID
			if(@whonext='')
				set @whonext='User'
		end
	end
	SELECT convert(varchar(100),count(*)) counting,  @whonext whonext, @vari varified  from ControlAppCmd where SubId=@userID
END
GO
PRINT N'Altering Procedure [dbo].[USP_SendChat]...';


GO
ALTER PROCEDURE [dbo].[USP_SendChat]
	@SenderId int ,
	@ReceiverId int,
	@message varchar(max),
	@RecUserName varchar(250)=''
AS

	declare @newother int
	if @RecUserName!=''
	BEGIN
		select @newother=ID 
		FROM Users
		where [Screen Name]=  @RecUserName
	END
	ELSE
	BEGIN
		SET @newother=@ReceiverId
	END

	Insert into ChatLog
	(ReceiverID ,
	SenderID ,
	ChatTxt)
	values
	(@newother,
	@SenderId,
	@message)
GO
PRINT N'Creating Procedure [dbo].[USP_GetRels]...';


GO
CREATE PROCEDURE [dbo].[USP_GetRels]
	@MyID int
AS
SELECT
    STUFF(
        (
select ',['+UserName+']' AS [text()]
from
(
	SELECT [Screen Name] UserName 
	from Relationship r
	join Users u on r.SubID=u.Id
	where SubID=@MyID 
	union
	SELECT [Screen Name] UserName 
	from Relationship r
	join Users u on r.DomID=u.Id
	where SubID=@MyID 
	) as sub
	FOR XML PATH (''), TYPE
	).value('text()[1]','nvarchar(max)'), 1, 1, '')
GO
PRINT N'Creating Procedure [dbo].[usp_tidyup]...';


GO
CREATE proc usp_tidyup
as
begin

delete from CommandList
where senddate<dateadd(day,-5,getdate())
delete from [ControlAppCmd] where subid in 
(
	select subid from [ControlAppCmd] cac
	left join CommandList cl
	on cac.CmdId=cl.CmdId
	where cl.CmdId is null

)

delete from CommandList where CmdId in 
(
	select cac.CmdId from CommandList cac
	left join [ControlAppCmd] cl
	on cac.CmdId=cl.CmdId
	where cl.CmdId is null

)

delete from VarificationReq where VerifyDate<dateadd(day,-5,getdate())

delete from usersgroups where grouprefid=-11 and userid <>1

end
GO
PRINT N'Refreshing Procedure [dbo].[Usp_checkuser]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[Usp_checkuser]';


GO
PRINT N'Refreshing Procedure [dbo].[Usp_GetVerificationReq]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[Usp_GetVerificationReq]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_requestvar]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_requestvar]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_varify]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_varify]';


GO
PRINT N'Update complete.';


GO
